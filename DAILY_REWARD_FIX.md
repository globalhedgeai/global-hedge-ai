# إصلاح نظام المكافأة اليومية

## المشكلة الأصلية
كان النظام يعطي مكافأة ثابتة $1.00 يومياً لجميع المستخدمين، بغض النظر عن رصيدهم أو مستوى الدعوات.

## الحل المطبق
تم إصلاح النظام ليعمل بالطريقة الصحيحة:

### 1. حساب المكافأة اليومية
المكافأة اليومية تُحسب الآن بناءً على:
- **الرصيد الأساسي**: مجموع الإيداعات المقبولة للمستخدم
- **نسبة الأرباح الشهرية**: حسب مستوى الدعوات
- **الصيغة**: `المكافأة اليومية = (الرصيد الأساسي × نسبة الأرباح الشهرية) ÷ 30`

### 2. مستويات الأرباح الشهرية
- **المستوى الأساسي**: 25% شهرياً (0-4 دعوات مؤكدة)
- **المستوى الأول**: 30% شهرياً (5+ دعوات مؤكدة)
- **المستوى الثاني**: 35% شهرياً (10+ دعوات مؤكدة)

### 3. مثال على الحساب
للمستخدم برصيد $1000:
- **المستوى الأساسي**: $8.33 يومياً ($250 شهرياً)
- **المستوى الأول**: $10.00 يومياً ($300 شهرياً)
- **المستوى الثاني**: $11.67 يومياً ($350 شهرياً)

## الملفات المحدثة

### 1. `apps/web/src/lib/policies.ts`
- إضافة `monthlyRates` للسياسات
- إزالة `amount` الثابت من `dailyReward`

### 2. `apps/web/src/lib/dailyRewardCalculator.ts` (جديد)
- دالة `getUserMonthlyRate()`: حساب نسبة الأرباح حسب المستوى
- دالة `calculateDailyReward()`: حساب المكافأة اليومية
- دالة `checkClaimEligibility()`: التحقق من إمكانية المطالبة

### 3. `apps/web/src/app/api/rewards/daily/claim/route.ts`
- استخدام `DailyRewardCalculator` بدلاً من المبلغ الثابت
- إضافة معلومات مفصلة في الاستجابة (المستوى، نسبة الأرباح، إلخ)

### 4. `apps/web/src/app/api/rewards/daily/status/route.ts`
- استخدام `DailyRewardCalculator` لحساب المكافأة المتاحة
- إضافة معلومات مفصلة عن حالة المستخدم

## المزايا الجديدة

✅ **عدالة في التوزيع**: المكافأة تعتمد على رصيد المستخدم الفعلي
✅ **حافز للدعوات**: زيادة المكافأة مع زيادة مستوى الدعوات
✅ **شفافية كاملة**: معلومات مفصلة عن المستوى ونسبة الأرباح
✅ **مرونة في الإدارة**: سهولة تعديل النسب من لوحة الإدارة
✅ **تتبع دقيق**: حفظ تفاصيل كل مطالبة في قاعدة البيانات

## كيفية العمل

1. **المستخدم يطالب المكافأة اليومية**
2. **النظام يحسب الرصيد الأساسي** (الإيداعات المقبولة)
3. **النظام يحدد مستوى المستخدم** (بناءً على الدعوات المؤكدة)
4. **النظام يحسب المكافأة اليومية** باستخدام الصيغة الجديدة
5. **النظام يضيف المكافأة للرصيد** ويحفظ التفاصيل

## ملاحظات مهمة

- **عدم المطالبة = فقدان الأرباح**: المستخدم يجب أن يطالب يومياً
- **الرصيد الأساسي فقط**: المكافأة تُحسب على الإيداعات المقبولة فقط
- **إعادة تعيين يومية**: النظام يعيد تعيين كل يوم في منتصف الليل UTC
- **تحديث المستوى**: المستوى يُحدد بناءً على الدعوات المؤكدة (المستخدمون الذين أودعوا)

## اختبار النظام

تم اختبار النظام بنجاح وأظهر النتائج التالية:
- حساب صحيح للمكافآت اليومية
- تحديث المستويات بناءً على الدعوات
- حفظ المعلومات التفصيلية في قاعدة البيانات
- معالجة صحيحة للحالات الاستثنائية
