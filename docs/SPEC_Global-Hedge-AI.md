# مواصفات تنفيذ الموقع والتطبيق (جاهزة للإرسال إلى Lovable.dev)

> **اسم المنتج (مبدئي):** Global-Hedge-AI
>
> **نطاق التنفيذ:** موقع ويب + تطبيق هاتف (iOS/Android)
>
> **الهدف:** منصة استثمار/عائدات شهرية بواجهة فخمة مستوحاة من التعدين السحابي والتداول الآلي، مع إدارة أرصدة، إيداع/سحب، مكافأة يومية قابلة للمطالبة، برنامج دعوات يرفع نسبة الربح، ولوحة تحكم للمسؤول للمراجعة والموافقة والإدارة الشاملة.

---

## 1) الهوية البصرية والتصميم (UI/UX)

**الطابع:** فخم، داكن، حديث، مستوحى من عالم الكريبتو/الذكاء الاصطناعي.

* **لوحة الألوان (Dark):**

  * الخلفية الأساسية: #0B1220 (كحلي داكن)
  * السطوح/البطاقات: #111827
  * نص أساسي: #E5E7EB
  * نص ثانوي: #9CA3AF
  * تمييز/أزرار أساسية: تدرّج من #6EE7F9 → #A78BFA
  * لون ربح/نجاح: #22C55E
  * لون تحذير/مهم: #F59E0B
  * لون خطر/رفض: #EF4444

* **الخطوط:**

  * عربي: "Tajawal" أو "IBM Plex Sans Arabic" أو "Cairo" (دعم كامل للـ RTL)
  * لاتيني: "Inter" أو "IBM Plex Sans"

* **أسلوب الرسومات:**

  * رسوم Isometric ثلاثية الأبعاد (خوادم، رزم عملات، مخططات AI)
  * مؤثرات متحركة خفيفة (Lottie) في الهيرو والتحميل
  * أيقونات: Lucide/Phosphor (خطوط أنيقة وموحدة)

* **خطوط تصميم رئيسية:**

  * بطاقات بزوايا مستديرة كبيره (rounded-2xl) وظلال ناعمة
  * مساحات بيضاء مريحة، تقسيم شبكي (CSS Grid)
  * داكن/فاتح (خيار الوضع الفاتح اختياري لاحقًا)

* **قابلية الوصول (a11y):** تباين ألوان جيد، أحجام خط مناسبة، دعم لوحة المفاتيح والقارئ الصوتي.

---

## 2) الأدوار والمستخدمون

* **المستخدم النهائي (User):** التسجيل/تسجيل الدخول، إدارة الإيداع والسحب، مشاهدة الأرباح، المطالبة بالمكافأة اليومية، إدارة العنوان الشبكي للسحب، الاطلاع على الأسواق والشموع، تتبّع سجل العمليات، تلقي الرسائل/الإشعارات، المشاركة في برنامج الدعوات.
* **الدعم (Support):** الرد على الرسائل، إدارة التذاكر، الاطلاع على حسابات المستخدمين (دون صلاحيات مالية).
* **المحاسبة (Accounting):** مراجعة إثباتات الإيداع، تسوية مبالغ الإيداع المقبولة، تدقيق السحوبات وتأكيدها على السلسلة.
* **المسؤول (ADMIN):** إدارة شاملة؛ إعدادات السياسات، الموافقات، إدارة المستخدمين والأدوار، التحكم بالمكافآت، إدارة المحتوى.

> **تنبيه امتثال:** لا ندعم أي تعديل "سري" على السجلات المالية دون أثر تدقيقي. أي تعديل إداري يجب أن يُسجَّل في **سجل تدقيقي غير قابل للحذف** مع ذكر المُعدِّل والسبب والطابع الزمني. يمكن إخفاء الأثر في شاشة المستخدم إن لزم، لكن يجب أن يبقى محفوظًا قانونيًا في السجل التدقيقي.

---

## 3) السياسات المالية والعمولات (أساسية)

### 3.1 الإيداع

* **عنوان محفظة الشركة الثابت (TRC20/USDT):** `TKaAamEouHjG9nZwoTPhgYUerejbBHGMop`
* الإيداع يتم عبر نسخ العنوان أو مسح QR.
* يجب على المستخدم رفع **صورة إثبات الإيداع** + إدخال **TXID**.
* الإيداعات تبقى **قيد المراجعة** حتى يُوافق عليها المسؤول/المحاسبة.
* **عمولة الإيداع:** 2% (قابلة للضبط من لوحة المسؤول). إن رغبتَ بإلغائها اضبطها 0%.
* أقل/أقصى مبلغ إيداع: قابلة للتهيئة (افتراضيًا: حد أدنى 100 USDT).


### 3.2 السحب

* على المستخدم إضافة **عنوان محفظة السحب** وتحديد **نوع الشبكة** (افتراضي: TRC20/USDT) قبل إنشاء طلب السحب.

* **خيارات السحب والعمولة:**
  * **سحب أسبوعي (Weekly):** عمولة **5%**.
  * **سحب شهري (Monthly):** عمولة **3%**.

* **شروط السحب:**
  * أوّل سحب مسموح **بعد 45 يومًا** من أول إيداع مقبول (ينطبق على الأسبوعي والشهري).
  * في **السحب الأسبوعي**: يسمح بالسحب التالي كل **7 أيام** من تاريخ آخر سحب مقبول.
  * في **السحب الشهري**: يسمح بالسحب التالي كل **30 يومًا** من تاريخ آخر سحب مقبول.
  * كل عملية سحب محدودة بـ **35% من الرصيد** بعد خصم العمولة.
  * حدود دنيا/عليا قابلة للتهيئة (افتراضي: حد أدنى 10 USDT).

* **حاسبة السحب:**
  * تعرض صافي المبلغ مباشرة حسب الخيار المختار (أسبوعي 5% / شهري 3%) + قيد 35% + القيود الزمنية (7/30 يوم).

* **حالة طلب السحب:**
  * قيد المراجعة → مقبول (مع TXID) / مرفوض (مع سبب).

### 3.3 الأرباح الشهرية والمكافأة اليومية

* **النسبة الأساسية (Tier 0):** 25% شهريًا **(قابلة للضبط)**.
* **طريقة احتساب اليومية:** تحويل النسبة الشهرية إلى معدل يومي:
  $r_\text{daily} = (1 + r_\text{monthly})^{1/30} - 1$
  يتم توليد رصيد يومي متاح للمطالبة.
* **زر المطالبة اليومية:** يجب أن يضغط المستخدم يوميًا للمطالبة. إن لم يطالب، **يفقد أرباح ذلك اليوم** (لا تتراكم تلقائيًا).
* **مكافأة عشوائية يومية (اختياري):** نسبة من المستخدمين (افتراضي 5%) يحصلون على مكافأة ثابتة (افتراضي $0.20). القيم قابلة للتهيئة.

### 3.4 الدعوات (Referral Tiers)

* لكل مستخدم **كود دعوة** خاص. عند تسجيل مستخدم جديد عبر الدعوة وتحقُّق أول إيداع، يُحتسب ضمن نقاط الداعي.
* **شرائح العائد:**
  * **حساب عادي (0–4 دعوات):** 25% شهريًا
  * **بعد 5 دعوات مؤكدة:** 30% شهريًا
  * **بعد 10 دعوات مؤكدة:** 35% شهريًا
* يمكن ضبط الحدود والنِّسب من لوحة المسؤول، مع سقف (مثلاً 40%).

> **إخلاء مسؤولية:** هذه نسب افتراضية. يُنصح بإظهار تحذير واضح "الأداء السابق لا يضمن النتائج المستقبلية"، وعدم تقديم وعود مضمونة قانونيًا.

---

## 4) الصفحات والواجهات (Web + Mobile)

### 4.1 عام

* **الصفحة الرئيسية (Landing):**
  * هيرو متحرك (AI/Mining رسومات ثلاثية)، شرح موجز، CTA للتسجيل
  * بطاقات المزايا، سلايدر آراء، شارات أمان/امتثال
* **الأسواق (Markets):**
  * أسعار لحظية، **شموع OHLC** (1m/5m/1h/1d)، أحجام، مؤشرات أساسية (MA/RSI)
  * قائمة مراقبة (Watchlist)
  * صفحة تفاصيل السوق مع تعليمات وتحذير مخاطر
* **التعليمات (Help Center):** أسئلة شائعة، أدلة مصورة/فيديو
* **الرسائل/صندوق الوارد:** إشعارات النظام، رسائل الدعم، إعلانات
* **التواصل (Contact):** نموذج مراسلة + روابط القنوات الرسمية
* **سياسات/شروط الاستخدام/الخصوصية:** صفحات ثابتة مُدارة من لوحة المحتوى (CMS)
* **تبديل اللغة:** العربية/الإنجليزية/الإسبانية/الفرنسية/الإيطالية + دعم RTL

### 4.2 بعد تسجيل الدخول (المستخدم)

* **لوحة المستخدم (Dashboard):**
  * الرصيد الكلي، رصيد متاح، الأرباح المتراكمة
  * نسبة الحساب الحالية (25/30/35%) ومؤشر تقدم الدعوات
  * زر **المطالبة اليومية** + عدّ تنازلي لليوم القادم
  * ويدجت الأسواق (أسعار سريعة/شموع مصغّرة)

* **الإيداع (Deposit):**
  * عرض **عنوان الشركة الثابت TRC20** + QR + نسخ بنقرة
  * حقل مبلغ تقريبي، حقل **TXID**، رفع **صورة الإثبات** (jpg/png/webp، حجم محدود)
  * حالة الإيداعات (قيد المراجعة/مقبول/مرفوض مع السبب)

* **السحب (Withdraw):**
  * إعداد **عنوان السحب** + **نوع الشبكة** (قائمة: TRC20/USDT… قابلة للتوسعة مستقبلًا)
  * حاسبة السحب: يُظهر صافي المبلغ بعد **3%** وقيود الـ 35% والحدود الدنيا/الدورية
  * إنشاء طلب → متابعة الحالة (قيد المراجعة/مقبول مع TXID/مرفوض مع السبب)

* **الدعوات (Referrals):**
  * كود/رابط الدعوة، عدد المدعوّين المؤكدين، تقدم الشريحة التالية
  * قائمة المدعوّين وحالة أول إيداع لكلٍ منهم

* **السجل (Transactions):**
  * تبويب الإيداعات/السحوبات/المكافآت/البونص
  * فلاتر (حالة/تاريخ/مبلغ)، تصدير CSV

* **الإعدادات (Settings):**
  * الملف الشخصي، تغيير كلمة المرور، 2FA (اختياري)
  * اللغة/الوضع الداكن
  * إدارة **عناوين السحب** والشبكات
  * إدارة الإشعارات (Email/In-App)

### 4.3 لوحة المسؤول (Admin)

* **نظرة عامة (KPIs):** إجمالي الأرصدة، الإيداعات اليومية، السحوبات، الأرباح الموزعة، التحويلات المعلَّقة
* **المستخدمون:** بحث/فرز، تفاصيل شاملة (الرصيد، العناوين، الدعوات، السجل)
* **الإيداعات:** قائمة إثباتات، استعراض الصورة، التحقق من **TXID**، قبول/رفض مع سبب، تعديل المبلغ المقبول إذا لزم (مع سجل تدقيقي)
* **السحوبات:** تحقق العنوان/الشبكة، تحقق القيود (45 يوم/7 أيام/35%)، قبول/رفض، تسجيل **TXID**، التكامل مع بوابة دفع/محفظة خزينة إن وُجدت
* **السياسات والإعدادات:**
  * ضبط نسب الأرباح الشهرية الأساسية + زيادات الدعوات + السقف
  * ضبط عمولة الإيداع/السحب والحدود الدنيا/العليا وفترات السحب
  * إدارة عنوان محفظة الشركة الثابت (TRC20) وعناوين بديلة مستقبلًا
  * تفعيل/تعطيل مكافأة يومية/مكافأة عشوائية وضبط معاييرها
  * إدارة اللغات والمحتوى (FAQ/سياسات/رسائل النظام)
* **السجل التدقيقي (Audit Log):**
  * كل تعديل إداري يُسجَّل (من، ماذا، متى، لماذا)
  * **غير قابل للحذف** من الواجهة، للتوافق والامتثال

> **ملاحظة مهمة:** طلب "تعديل التواريخ/السجلات بدون معرفة المستخدم" غير مقبول امتثاليًا. البديل: تعديل مسموح مع **أثر تدقيقي**، وإشعار المستخدم عند تغييرات تؤثر رصيده (يمكن إخفاء تفاصيل داخلية غير مالية عند الحاجة، لكن الأثر محفوظ).

---

## 5) نماذج البيانات (Data Model)

> صيغ عامة قابلة للتطبيق على أي باك‑إند. (أسماء الحقول بالعربية للشرح — يُنصح بالإنجليزية في قاعدة البيانات.)

* **User**: id, email (unique), passwordHash, role {USER, ADMIN, SUPPORT, ACCOUNTING}, createdAt, balance, firstDepositAt, lastWithdrawalAt, referralCode (unique), invitedById
* **Tier**: id, name, monthlyRate (decimal), minInvites, maxInvites
* **Deposit**: id, userId, amount, txId, proofImageUrl, network (TRC20), toAddress (شركة), status {PENDING, APPROVED, REJECTED}, reviewedBy, reviewedAt, effectiveAt
* **Withdrawal**: id, userId, amountRequested, feePercent (default 3), amountNet, network (TRC20), toAddress, status {PENDING, APPROVED, REJECTED}, txId, reviewedBy, reviewedAt, effectiveAt
* **DailyRewardClaim**: id, userId, claimDate (unique per user/date), amount, status
* **RandomBonus**: id, userId, date, amount (ex: 0.20), ruleId
* **Referral**: id, inviterId, inviteeId, confirmedAt (بعد أول إيداع)
* **Policy**: id, key, value (مثل: minWithdrawDaysFirst=45, intervalWithdrawDays=7, maxWithdrawPercent=35, depositFee=2, withdrawFee=3, baseMonthly=25, tier5=30, tier10=35, bonusChance=5, bonusAmount=0.2)
* **AuditLog**: id, actorId, entityType, entityId, action, before, after, reason, timestamp
* **Message**: id, userId (nullable), type {SYSTEM, SUPPORT, ANNOUNCEMENT}, title, body, readAt

---

## 6) منطق الأعمال (Business Logic)

* **احتساب الرصيد اليومي المتاح للمطالبة:**
  * تحويل نسبة الشهر إلى يوم كما بالمعادلة أعلاه.
  * حساب على أساس الرصيد الفعلي (بعد الموافقات والخصومات).
  * عدم المطالبة = خسارة أرباح اليوم.

* **قيود السحب:**
  * التحقق الآلي قبل قبول الطلب (45 يوم/7 أيام/35%).
  * تطبيق عمولة 3% فورًا، حساب الصافي.

* **الدعوات:**
  * تحديث شريحة المستخدم تلقائيًا عند بلوغ 5/10 دعوات مؤكَّدة.
  * تطبيق النسبة الأعلى من بداية الشهر التالي (قابل للتهيئة فورًا إن رغبت).

* **الإيداع:**
  * مطابقة TXID مع الشبكة (TRC20) قدر الإمكان.
  * قبول/رفض مع سبب، وتحديد تاريخ النفاذ (effectiveAt) عند القبول.

* **التعديلات الإدارية:**
  * أي تعديل على مبلغ/تاريخ عملية يمر عبر واجهة "تحرير" تُسجّل before/after + السبب في **AuditLog**.

---

## 7) الـ APIs (مخطط عام)

* **Auth:**
  * **POST /auth/register** `{ email, password, referralCode? }` ← **حقل كود الدعوة اختياري** عند التسجيل. إن وُجد وتحقق لاحقًا (أول إيداع للمدعو)، يُحتسب ضمن الدعوات.
  * **POST /auth/login** `{ email, password }`
  * **POST /auth/logout**
  * **POST /auth/verify-email** `{ token }` (اختياري إذا كان هناك تفعيل بريد)
  * **POST /auth/forgot-password** `{ email }` → إنشاء **رمز إعادة تعيين** وإرسال رابط على البريد.
  * **POST /auth/reset-password** `{ token, newPassword }` → يتحقق من صلاحية الرمز (مرة واحدة) ويُحدّث كلمة المرور.
  * **POST /auth/2fa/verify** (اختياري)

* **Profile:** GET/PUT /me, GET/PUT /me/withdraw-address

* **Deposits:** POST /deposits (amount, txId, proofImage), GET /deposits, GET /deposits/:id

* **Withdrawals:** POST /withdrawals (amount), GET /withdrawals, GET /withdrawals/:id

* **Rewards:** POST /rewards/claim (اليومي), GET /rewards/history

* **Referrals:** GET /referrals, GET /referrals/code

* **Markets:** GET /markets/tickers, GET /markets/candles?symbol=BTCUSDT&tf=1h

* **Messages:** GET /messages, POST /messages/read

* **Admin:**
  * Users: GET /admin/users, GET /admin/users/:id, PUT /admin/users/:id/role
  * Deposits: GET /admin/deposits, PUT /admin/deposits/:id (approve/reject, amount/effectiveAt)
  * Withdrawals: GET /admin/withdrawals, PUT /admin/withdrawals/:id (approve/reject, txId)
  * Policies: GET/PUT /admin/policies
  * Content: CRUD /admin/content (FAQ/Terms)
  * Audit: GET /admin/audit?entityType=Deposit&entityId=...

> جميع مسارات **/admin/** خلف حارس RBAC (دور ADMIN/ACCOUNTING فقط)، مع توثيق جلسة آمن، CSRF، ومحدد معدّل (Rate Limit). بالنسبة لإعادة تعيين كلمة السر: تخزين الرموز على شكل **tokenHash** مع **expiresAt** و**usedAt**، وصلاحية قصيرة (مثل 30–60 دقيقة) واستخدام لمرة واحدة.

---

## 8) الأمان والامتثال

* **جلسات/توثيق:** JWT مع مدة معقولة + Refresh، أو جلسات سيرفرية مع Iron‑Session. 2FA اختياري.
* **RBAC صارم:** حماية كل مسارات /admin/* بدور ADMIN/ACCOUNTING. عدم الاكتفاء بوجود session.
* **CSR**F: حماية كل POST/PUT/DELETE.
* **CORS:** السماح فقط لنطاقاتك الرسمية.
* **الأسرار:** في متغيرات بيئية فقط (JWT_SECRET, IRON_SESSION_PASSWORD, DATABASE_URL …) مع تدوير دوري.
* **رفع الملفات:** قبول صور الإثبات فقط (MIME/امتداد)، حجم/عدد محدود، تخزين آمن (S3/Cloud) مع روابط موقّتة.
* **السجل التدقيقي:** غير قابل للحذف/التحرير من الواجهة، للامتثال.
* **إشعارات التغييرات:** أي تغيير يؤثر الرصيد يُخطر المستخدم.

---

## 9) اللغات والتدويل (i18n)

* لغات: العربية (RTL)، الإنجليزية، الإسبانية، الفرنسية، الإيطالية.
* ملفات رسائل منظمة (مثلاً: `messages/ar.json` …)، مفاتيح موحّدة.
* عناصر RTL (اتجاه النص/الأيقونات/الجداول) مضبوطة تلقائيًا.

---

## 10) التحليلات والمقاييس

* تتبّع الأحداث الأساسية (إيداع، سحب، مطالبة يومية، دعوة، رفض/قبول).
* لوحات متابعة (Admin): نمو المستخدمين، معدلات قبول/رفض، أرباح موزعة، نشاط يومي.

---

## 11) المحتوى الثابت والنصوص القانونية

* سياسة الخصوصية، شروط الاستخدام، إخلاء مسؤولية الأرباح، سياسة مكافحة الاحتيال.
* صفحات توعوية بالمخاطر.

---

## 12) إجراءات التسليم إلى Lovable.dev

1. **أرسل هذا المستند** كمتطلبات رسمية (PRD).
2. **زوّد الأصول البصرية:** الشعار (SVG/PNG)، الألوان، الخطوط، أي رسومات/لوتي.
3. **زوّد نصوص المحتوى:** الهيرو، الأقسام، FAQ، السياسات (يمكننا تزويد نصوص أولية لاحقًا).
4. **البيانات التهيئية:** عنوان محفظة الشركة (TRC20) أعلاه، نسب الأرباح/الدعوات، العمولات، القيود.
5. **هيكل البيانات وواجهات API** (المذكورة هنا) كأساس التوصيل مع الباك‑إند.
6. **قائمة الشاشات** (كما فصّلنا) لكل من الويب والموبايل.
7. **قبول الجودة/الاختبارات:** اختبارات قبول لكل تدفق (مذكورة أدناه).

> ملاحظة: إن كان Lovable.dev سيبني أيضًا الباك‑إند، شارك مخطط البيانات بالكامل وسياسات الأمان، وإلا فوفّر له Mock APIs أو Swagger.

---

## 13) حالات الاستخدام واختبارات القبول (نماذج)

* **تسجيل مستخدم جديد** → تفعيل البريد → دخول أول → عرض Dashboard صحيح.
* **إضافة عنوان سحب** → حفظ الشبكة/العنوان → تحقق تنسيقي.
* **إيداع** → رفع صورة إثبات + TXID → الحالة قيد المراجعة → قبول من Admin → تحديث الرصيد و"effectiveAt".
* **سحب** → التحقق من 45/7/35% → إنشاء طلب → قبول Admin → ظهور TXID للمستخدم.
* **مطالبة يومية** → زيادة الرصيد القابل للسحب وفق اليوم.
* **دعوات** → الوصول لـ 5/10 دعوات مؤكدة → ترقية الشريحة (30%/35%).
* **رفض إداري** → سبب واضح للمستخدم + حفظ في Audit.
* **تغيير سياسة** (مثلاً عمولة السحب) → تنعكس فورًا على الحاسبات.

---

## 14) خارطة تقنية مختصرة (إن لزم)

* **Front‑end:** Web (Next.js/React) + Mobile (React Native/Expo) — أو حسب قدرات Lovable.
* **Charts:** TradingView widget أو Lightweight‑Charts للشموع.
* **Auth:** JWT/Session مع 2FA.
* **Storage:** S3‑compatible لصور الإثبات.
* **DB:** PostgreSQL + جداول كما في نموذج البيانات.
* **البنية:** بيئات Dev/Prod، متغيرات بيئية منفصلة.

---

## 15) ما يلزم من العميل الآن

* تأكيد النِّسب والعمولات الافتراضية (25%، 30%، 35%، عمولة إيداع 2%، عمولة سحب 3%).
* تأكيد الشبكة الافتراضية (TRC20/USDT) وعنوان الشركة.
* تزويد الشعار والأصول البصرية.
* أي متطلبات قانونية خاصة بالولاية القضائية.

---

### ملحوظة ختامية

هذه الوثيقة كافية لبدء التنفيذ فورًا على Lovable.dev (ويب + موبايل). أي طلب تخصيص إضافي (ألوان، نصوص، شاشات مخصّصة) يمكن إضافته كتحديث إصدار v1.1.

---

## 16) Prisma & قاعدة البيانات (ORM/Migrations/Seeding)

* **ORM:** اعتماد **Prisma** مع **PostgreSQL**.
* **المخطط (Models) الأساسية المقترحة:**

  * User, Tier, Deposit, Withdrawal, DailyRewardClaim, RandomBonus, Referral, Policy, AuditLog, Message
  * **PasswordResetToken**: `{ id, userId, tokenHash, expiresAt, usedAt, createdAt }` (تخزين **hash** فقط، لا نخزن الرمز الصريح)
  * **EmailVerificationToken** (اختياري) بنفس الفكرة أعلاه
* **قيود/فريد:**

  * `User.email` فريد، `User.referralCode` فريد
  * `DailyRewardClaim (userId, claimDate)` فريد لكل يوم/مستخدم
  * `PasswordResetToken.tokenHash` فريد
* **فهارس مقترحة:** على `createdAt` في الجداول عالية الكتابة (Deposit/Withdrawal/AuditLog) لتحسين الاستعلامات.
* **الهجرات (Migrations):**

  * بيئة التطوير: `prisma migrate dev`
  * الإنتاج: `prisma migrate deploy`
* **التهيئة (ENV):** `DATABASE_URL`, `JWT_SECRET`, `IRON_SESSION_PASSWORD` … إلخ (لا نسرب أسرارًا في الكود).
* **Seed مبدئي:**

  * إنشاء أدوار/سياسات افتراضية (نِسَب الأرباح، العمولات، الحدود، الإعدادات)
  * إنشاء مستخدم **Admin** أولي (انظر القسم التالي)

## 17) إضافة حساب مسؤول (طريقتان موصى بهما)

1. **من لوحة التحكم (Production Ready):**

   * صفحة **Admin → Users**: زر "إنشاء مستخدم" → إدخال البريد/كلمة المرور → اختيار الدور **ADMIN** → حفظ.
   * يتطلب أن يكون لديك مسبقًا حساب مسؤول واحد لتسجيل الدخول.

2. **عن طريق Prisma (Seed/CLI) — للتهيئة الأولى:**

   * سكربت seed يستدعي Prisma Client:

     * يتحقق إن كان هناك Admin؛ إن لم يوجد يُنشئ مستخدمًا جديدًا بالبيانات التالية (مثال):

       * email: admin@yourdomain.tld
       * passwordHash: (تجزئة قوية لـ كلمة مرور أولية)
       * role: ADMIN
     * يطبع التعليمات لتغيير كلمة المرور فور الدخول.
   * التنفيذ: `prisma migrate deploy && prisma db seed`

> **مهم:** حتى مع الإنشاء عبر Seed، يجب فرض تغيير كلمة المرور عند أول تسجيل دخول، وتسجيل هذا الحدث في **AuditLog**.

---

## 18) الاستمرارية وحفظ البيانات (Persistence & Reliability)

**الهدف:** ضمان عدم فقدان بيانات المستخدم حتى لو انقطع التيار/انطفأ الجهاز/أُغلق التطبيق فجأة.

* **مصدر الحقيقة Server‑Side:**

  * كل العمليات الحرجة (إنشاء حساب، تحديث الملف الشخصي، الإيداعات، السحوبات، المطالبات اليومية، الدعوات، إعدادات السياسات) تُحفظ في **قاعدة البيانات** فور قبولها عبر API.
  * يتم استخدام **Prisma** مع **PostgreSQL** ومعاملات **ACID** (Transactions) لحفظ الاتساق.

* **Idempotency & Transactions:**

  * نقاط نهاية حرجة (مثل `POST /withdrawals`, `POST /deposits`) تدعم **Idempotency-Key** لمنع التكرار عند إعادة الإرسال بعد انقطاع.
  * معاملات قاعدة البيانات تضمن إما نجاحًا كاملًا أو فشلًا دون حالات وسيطة.

* **حفظ مسودات الواجهة (Optional Autosave):**

  * مسودات النماذج (مثل نموذج الإيداع قبل الإرسال النهائي) تُخزَّن محليًا **(localStorage)** كنسخة مؤقتة؛ عند إعادة فتح التطبيق تُستعاد للمستخدم لإتمامها. لا تُحتسب أي عملية إلا بعد الإرسال والموافقة Server‑Side.

* **الرفع المتقطّع للملفات:**

  * رفع صورة إثبات الإيداع يدعم **استئناف/إعادة الرفع** عند الانقطاع. التخزين إلى S3/متوافق S3 مع **Versioning**.

* **الجلسات والتوثيق:**

  * جلسات آمنة (JWT أو Iron‑Session). عند إعادة فتح التطبيق، يتم **استئناف الجلسة** إن كانت صالحة؛ وإلا يُعاد التوثيق. إعادة تعيين كلمة السر تُبطل الرموز القديمة.

* **النسخ الاحتياطي (Backups) والتعافي:**

  * PostgreSQL: **نقطة‑في‑الزمن** (PITR) + نسخ يومية كاملة ونسخ تفاضلية/ساعية.
  * أهداف التعافي: **RPO ≤ 15 دقيقة**, **RTO ≤ 30 دقيقة** (قابلة للضبط حسب البنية).
  * صور الإثبات: تخزين كائنات مع **Versioning** وتمكين **Lifecycle Policies**.

* **القياس والمراقبة:**

  * سجلات مركزية (Structured Logs) ومقاييس (نجاح/فشل، زمن الاستجابة)، وتنبيهات على الأخطاء الحرجة.

* **اختبارات قبول مرتبطة:**

  * إغلاق التطبيق أثناء إنشاء سحب قبل الإرسال النهائي → لا يُنشأ طلب.
  * إغلاق التطبيق بعد إرسال الإيداع مباشرة → عند إعادة الفتح، تعرض الحالة **قيد المراجعة** (لأن العملية سُجِّلت Server‑Side).
  * إعادة إرسال نفس طلب السحب بنفس **Idempotency‑Key** → لا تتكرر العملية.

---

## 19) الوضع غير المتصل (Offline / PWA) — ويب وموبايل

**الغاية:** توفير تجربة آمنة وسلسة عند انقطاع الإنترنت بدون فقدان بيانات، مع منع تنفيذ عمليات مالية غير مؤكَّدة أثناء عدم الاتصال.

### 19.1 ويب (PWA)

* **Service Worker + Workbox**:

  * تفعيل PWA (manifest + icons + SW). تمكين التنصيب على سطح المكتب والجوال.
  * **استراتيجيات التخزين المؤقت (Caching Strategies):**

    * أصول ثابتة (JS/CSS/Fonts/Icons): `Cache First` مع نسخة وإصدار واضحين (revisioning).
    * **الأسواق/الشموع:** `Stale‑While‑Revalidate` مع TTL قصير (مثلاً 30–120ث) وتطبيع بيانات الشموع.
    * **Dashboard snapshot**: `Network First` مع fallback للنسخة الأخيرة المخزَّنة.
    * **الرسائل/الإشعارات**: `Network First`.
    * **السجل (Transactions)**: `Network First` مع fallback على آخر صفحة معروفة.
  * **Background Sync** (SyncManager): طابور طلبات غير مالية (مثل: تحديث بروفايل، قراءة رسائل).

    * **العمليات المالية** (إيداع/سحب): تُحفظ كـ **مسودات** فقط عند عدم الاتصال، ولا تُرسل تلقائيًا. عند عودة الاتصال تظهر نافذة تأكيد لإرسالها يدويًا.
* **IndexedDB (idb)**:

  * مخازن: `markets`, `candles`, `dashboardSnapshot`, `messages`, `transactions`, `drafts`.
  * سياسة احتفاظ (TTL) وتنظيف دوري، وزر "تفريغ الكاش" في الإعدادات.
* **Idempotency‑Key**:

  * على الطلبات الحرجة عند الإرسال (أونلاين) لضمان عدم التكرار في حال إعادة الإرسال.
* **الحماية**:

  * الجلسات عبر **HttpOnly cookies** أو `Secure Storage`؛ يمنع تخزين أي أسرار في IndexedDB.
  * تشفير اتصال فقط HTTPS، وتضييق CORS.
* **حالات واجهة واضحة**:

  * شارة/بِنر "غير متصل"، تعطيل أزرار الإرسال المالي، إتاحة "حفظ كمسودة".
  * عند عودة الاتصال: إشعار بإمكانية استئناف وإرسال المسودات (بتأكيد المستخدم).

### 19.2 موبايل (React Native / Expo)

* **التخزين المحلي**:

  * بيانات خفيفة: **MMKV**.
  * بيانات مهيكلة/قوائم: **expo‑sqlite** (جداول `markets`, `candles`, `messages`, `transactions`, `drafts`).
* **اكتشاف الاتصال**: `@react-native-community/netinfo` لإظهار حالة Offline.
* **Background Fetch**: تحديث دوري للأسواق والرسائل عندما يتوفر اتصال.
* **Notifications**: `expo-notifications` للتنبيهات (سعر/رسائل/مطالبة يومية).
* **الأمان**:

  * الرموز في **SecureStore/Keychain**، وقفل حيوي (Face/Touch ID) لفتح التطبيق إن فُعّل.
  * عدم تنفيذ عمليات مالية عند عدم الاتصال؛ السماح فقط بحفظ المسودات.

### 19.3 اختبارات قبول (Offline)

* فصل الإنترنت أثناء ملء نموذج سحب → حفظ مسودة محليًا، منع الإرسال، عند العودة يظهر زر "إرسال الآن".
* إعادة فتح التطبيق بدون اتصال → عرض Dashboard snapshot الماضي + تنبيه "غير متصل".
* إرسال نفس العملية بعد استئناف الاتصال مع **Idempotency‑Key** → لا تتكرر.

---
